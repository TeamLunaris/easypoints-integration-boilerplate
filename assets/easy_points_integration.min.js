window.addEventListener("DOMContentLoaded",function(){var a=this.window.location.pathname;a.match(/\/cart/i)&&(EasyPoints.reset({}),EasyPoints.Register.run())});var EasyPoints={Debug:{DEBUG:!0,print:function(a,b="info"){if(this.DEBUG)switch(a="[EasyPoints] "+a,b.toLowerCase()){case"warn":console.warn(a);break;case"error":console.error(a);break;default:console.info(a);}}},Selectors:{getElementBy$:function(a,b,c=!1){var a=c?a.querySelectorAll(b):a.querySelector(b);return a||EasyPoints.Debug.print("Could not locate "+b,"warn"),a},getTotalPointsEl:function(a,b=!1){return this.getElementBy$(a,"[data-loyal-target=\"total-points-value\"]",b)},getRedeemContainerEl:function(a,b=!1){return this.getElementBy$(a,".easy-points-form__container",b)},getRedeemPointsButtonEl:function(a,b=!1){return this.getElementBy$(a,".easy-points-button__redeem",b)},getResetPointsButtonEl:function(a,b=!1){return this.getElementBy$(a,".easy-points-button__reset",b)},getRedeemPointsInputEl:function(a,b=!1){return this.getElementBy$(a,".easy-points-form__input input",b)},getCheckoutButtonEl:function(a,b=!1){return this.getElementBy$(a,"[type=\"submit\"][name=\"checkout\"]",b)},getAdditionalCheckoutButtonEl:function(a,b=!1){return this.getElementBy$(a,".additional-checkout-buttons",b)}},Points:{getExcludedCost(){var a=Array.from(document.querySelectorAll("[data-loyal-target=\"point-exclusion\"]")).reduce((a,b)=>a+parseInt(b.dataset.loyalCurrencyCost),0);return a},getTotalBonusPoints(a=document){var b=Array.from(a.querySelectorAll("[data-loyal-bonus-points]")).reduce((a,b)=>{var{bonusPoints:c}=JSON.parse(b.dataset.loyalBonusPoints);return c=parseInt(c),!isNaN(c)&&0<c?a+c:a},0);return b},insertTotalPoints(a,{ignoreExcluded:b=!1,ignoreTax:c=!0}={}){EasyPoints.Selectors.getTotalPointsEl(a,!0).forEach(d=>{var e=parseInt(d.dataset.loyalCurrencyCost);b||(e-=EasyPoints.Points.getExcludedCost()),EasyPoints.Points.setCurrencyCost(d,{price:e,ignoreTax:c}),insertPointValue(d);var f=parseInt(d.innerText.replace(/\D/g,""));isNaN(f)&&(f=parseInt(d.textContent.replace(/\D/g,""))),f+=Math.round(EasyPoints.Points.getTotalBonusPoints(a)),insertPointValueIntoElement(d,f)})},getPriceFromEl:function(a,b=null,c=/[^\d]/g){var d=b?a.querySelector(b):a;return d?100*parseInt(d.textContent.replace(c,"")):null},getTaxedCost:function({price:a,tax:b},c=null){if(null!==c&&c.dataset.loyalOpts){var d=JSON.parse(c.dataset.loyalOpts);b=d.tax}return null===b?(EasyPoints.Debug.print("Tax object not defined.","error"),a):b.included?a:b.exempt?a:Math.floor(a*b.rate)},setCost(a,b,{price:c=null,multiplier:d=1,ignoreTax:e=!1}){if(c=(null===c?parseInt(a.dataset.loyalCurrencyCost):c)*d,0>=c)return void a.setAttribute(b,0);if(a.dataset.loyalOpts){var f=JSON.parse(a.dataset.loyalOpts);e||(c=this.getTaxedCost({price:c,tax:f.tax}))}a.setAttribute(b,c)},setCurrencyCost(a,b){this.setCost(a,"data-loyal-currency-cost",b)},resetTargets:function(a={},b=null,c=null){var d=null==c?"[data-loyal-target=\"point-value\"]":c+" [data-loyal-target=\"point-value\"]";document.querySelectorAll(d).forEach(b=>{b.classList.contains("points-after-applied-discount")||this.setCurrencyCost(b,a)}),b?b():updateLoyaltyTargets()}},Cart:{url:function(){return window.location.origin+"/cart.json"},getFromJSON:function(a){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===XMLHttpRequest.DONE){var c=b.status;0===c||200<=c&&400>c?a(JSON.parse(b.responseText)):EasyPoints.Debug.print("Failed getting data from /cart.json","error")}},b.open("GET",this.url()),b.setRequestHeader("accept","application/json"),b.send()},setRedemptionForm:function(){this.getFromJSON(function(a){var b=document.getElementById("point-redemption-form");b&&((maxRedeemableInput=b.querySelector("input[name=\"coupon[max_redeemable]\"]"))&&(maxRedeemableInput.value=a.total_price),a.items.forEach(function(a){var c=b.querySelectorAll("input[name=\"coupon[product_ids][]\"]"),d=Array.prototype.find.call(c,function(b){return b.value==a.product_id});if(!d){var e=document.createElement("input");e.setAttribute("type","hidden"),e.setAttribute("name","coupon[product_ids][]"),e.setAttribute("value",a.product_id),b.appendChild(e),EasyPoints.Debug.print("New cart item input created for the submission form.")}}))})}},UI:{showHidden:function(){EasyPoints.Selectors.getElementBy$(document,".hidden-unless-discount-applied",!0).forEach(a=>a.classList.remove("easy-points-hide"))},hideHidden:function(){EasyPoints.Selectors.getElementBy$(document,".hidden-unless-discount-applied",!0).forEach(a=>a.classList.add("easy-points-hide"))},cloneSubtotal:function(){EasyPoints.Selectors.getElementBy$(document,"[data-loyal-target=\"subtotal\"]",!0).forEach(a=>{var b=a.cloneNode(!0);b.removeAttribute("data-loyal-target"),b.setAttribute("data-loyal-clone","subtotal"),a.classList.add("easy-points-hide"),a.insertAdjacentElement("beforebegin",this.modifySubtotal(b))})},resetClonedSubtotal:function(){EasyPoints.Selectors.getElementBy$(document,"[data-loyal-clone]",!0).forEach(a=>a.remove()),EasyPoints.Selectors.getElementBy$(document,"[data-loyal-target=\"subtotal\"]",!0).forEach(a=>a.classList.remove("easy-points-hide"))},modifySubtotal:function(a){var b=a.querySelector("[data-loyal-target=\"total_price\"]");if(!b)return EasyPoints.Debug.print("modifySubtotal(el): missing total price target."),a;var c=EasyPoints.getDiscountSession(),d=b.dataset.loyalTotalPrice,{multiplier:e}=EasyPointsCore.Currency.getFormatOptions()||{multiplier:100},f=Math.round(c*EasyPointsCore.Currency.getRate()*e),g=d-f;if(0<=g){b.innerHTML=EasyPointsCore.Currency.format(g);var h=a.querySelector(".points-after-applied-discount");if(h){var i=parseInt(h.innerText.replace(/\D/g,"")),j=EasyPoints.Points.getTaxedCost({price:d,tax:null},h),k=EasyPoints.Points.getTaxedCost({price:g,tax:null},h);insertPointValueIntoElement(h,formatBigNumber(Math.max(0,Math.ceil(k/j*i))))}}return a},showDiscount:function(){this.showHidden(),this.buttonReset()},hideDiscount:function(){this.hideHidden(),this.buttonRedeem()},buttonRedeem:function(){EasyPoints.Selectors.getRedeemPointsInputEl(document,!0).forEach(a=>a.removeAttribute("disabled")),EasyPoints.Selectors.getResetPointsButtonEl(document,!0).forEach(a=>a.classList.add("easy-points-hide")),EasyPoints.Selectors.getRedeemPointsButtonEl(document,!0).forEach(a=>a.classList.remove("easy-points-hide"))},buttonReset:function(){EasyPoints.Selectors.getRedeemPointsInputEl(document,!0).forEach(a=>{a.setAttribute("disabled",!0);var b=EasyPoints.getDiscountSession();!a.classList.contains("valid")&&(""==a.value||0>=a.value)&&0<b&&(a.value=b)}),EasyPoints.Selectors.getResetPointsButtonEl(document,!0).forEach(a=>a.classList.remove("easy-points-hide")),EasyPoints.Selectors.getRedeemPointsButtonEl(document,!0).forEach(a=>a.classList.add("easy-points-hide"))}},Tiers:{recalculate:function(a=null){var{rankAdvancementData:b}=getEasyPointsSession();if(b||!(0<=b.raw_amount)){var c=EasyPoints.getDiscountSession(),{multiplier:d}=EasyPointsCore.Currency.getFormatOptions()||{multiplier:100},e=Math.round(c*EasyPointsCore.Currency.getRate()*d);if(null===a){var f=document.querySelector("[data-loyal-target=\"total_price\"]");if(!f)return void EasyPoints.Debug.print("recalculate(el): missing total price target.","error");a=f.dataset.loyalTotalPrice}try{var g=EasyPointsCore.Tiers.getNextTier(a-e);g?(Array.prototype.slice.call(document.querySelectorAll("[data-loyal-target=\"rank-advancement-tier-name\"]")).forEach(a=>{a.textContent=g.name}),Array.prototype.slice.call(document.querySelectorAll("[data-loyal-target=\"rank-advancement-amount\"]")).forEach(a=>{a.innerHTML=EasyPointsCore.Currency.format(g.advancementAmountMultiplied)})):Array.prototype.slice.call(document.querySelectorAll("[data-loyal-target=\"rank-advancement-data\"] > span")).forEach(a=>{a.style.display="max-rank"==a.dataset.loyalTarget?"":"none"})}catch{return void EasyPoints.Debug.print("EasyPoints Tiers: error getting next tier.","error")}}}},getDiscountSession:function(){var a=sessionStorage.getItem("appliedDiscount");return a?parseInt(a):0},applyDiscount:function(){var a=this.getDiscountSession();EasyPoints.Debug.print("Applying discount: "+a),0<a&&(displayDiscount(a),EasyPoints.UI.showDiscount(),EasyPoints.UI.cloneSubtotal(),EasyPoints.Selectors.getAdditionalCheckoutButtonEl(document,!0).forEach(a=>a.classList.add("easy-points-hide")))},reset:function({event:a=null}){EasyPoints.UI.hideDiscount(),EasyPoints.UI.resetClonedSubtotal(),EasyPoints.Selectors.getAdditionalCheckoutButtonEl(document,!0).forEach(a=>a.classList.remove("easy-points-hide")),sessionStorage.removeItem("appliedDiscount"),EasyPoints.Selectors.getRedeemPointsInputEl(document,!0).forEach(a=>a.value="")},Form:{update({points:a}){var b=EasyPoints.Selectors.getElementBy$(document,"#redemption-point-value");return b?(b.value=a,EasyPointsCore.Validate.pointRedemption()?(sessionStorage.setItem("appliedDiscount",a),EasyPoints.Selectors.getRedeemPointsInputEl(document,!0).forEach(a=>a.classList.remove("invalid")),!0):(sessionStorage.removeItem("appliedDiscount"),EasyPoints.Selectors.getRedeemPointsInputEl(document,!0).forEach(a=>a.classList.add("invalid")),!1)):(sessionStorage.removeItem("appliedDiscount"),!1)},redeem({event:a=null,points:b=null}){if(null==b){if(null==a)return EasyPoints.Debug.print("redeem({event, points}): cant get the points value","error"),!1;var c=a.target.closest(".easy-points-form__container");if(!c)return EasyPoints.Debug.print("redeem({event, points}): target form is not defined"),!1;(input=EasyPoints.Selectors.getRedeemPointsInputEl(c))&&(input.value=input.value.toString().replace(/[^\d]/g,""),b=input.value)}return this.update({points:b})},setCoupon(a=null,b=null){if(null!=b&&!b||0<EasyPoints.getDiscountSession()?(EasyPoints.Debug.print("Using /redeem"),form=buildForm("/apps/loyalty/redeem")):(EasyPoints.Debug.print("Using /reset"),form=buildForm("/apps/loyalty/reset")),form){var c=new XMLHttpRequest;c.onreadystatechange=function(){4==this.readyState&&(EasyPoints.Debug.print("Submitted"),a&&a())},c.open("POST",form.action);var d=new FormData(form);c.send(d),EasyPoints.Debug.print("Submitting form")}else a&&a()}},Register:{submissionReady:!1,run:function(){updateLoyaltyTargets(),EasyPoints.Points.insertTotalPoints(document),EasyPoints.Tiers.recalculate(),this.setEventListeners(),EasyPoints.applyDiscount()},setEventListeners:function(){0==EasyPoints.Selectors.getRedeemContainerEl(document,!0).length||(EasyPoints.Selectors.getRedeemPointsInputEl(document,!0).forEach(a=>{a.addEventListener("focus",this.onPointsInput),0<a.value&&EasyPoints.Form.update({points:EasyPoints.getDiscountSession()})}),EasyPoints.Selectors.getRedeemPointsButtonEl(document,!0).forEach(a=>a.addEventListener("click",this.onClickRedeemBtn)),EasyPoints.Selectors.getResetPointsButtonEl(document,!0).forEach(a=>a.addEventListener("click",this.onClickResetBtn)),EasyPoints.Selectors.getCheckoutButtonEl(document,!0).forEach(a=>a.addEventListener("click",this.onClickSetCoupon)),EasyPoints.Debug.print("Applied all required event listeners"))},onPointsInput:function(a){a.target.classList.remove("invalid")},onClickRedeemBtn:function(a){a.preventDefault(),EasyPoints.Debug.print("Clicked: Redeem"),EasyPoints.Register.submissionReady=!1,EasyPoints.Form.redeem({event:a})&&EasyPoints.applyDiscount()},onClickResetBtn:function(a){a.preventDefault(),EasyPoints.Debug.print("Clicked: Reset"),EasyPoints.Register.submissionReady=!1,EasyPoints.reset({event:a})},onClickSetCoupon(a,b=null){return EasyPoints.Debug.print("Clicked: checkout"),EasyPoints.Register.submissionReady?void EasyPoints.Debug.print("> ready to checkout"):void(EasyPoints.Debug.print("Setting coupon"),a.preventDefault(),a.stopPropagation(),checkoutBtn=a.target,checkoutBtn.style.cursor="progress",checkoutBtn.classList.add("btn--loading"),checkoutBtn.setAttribute("disabled",!0),EasyPoints.Form.setCoupon(function(){EasyPoints.Register.submissionReady=!0,checkoutBtn.style.cursor="unset",checkoutBtn.classList.remove("btn--loading"),checkoutBtn.removeAttribute("disabled"),checkoutBtn.click(),b&&b()}))}}};