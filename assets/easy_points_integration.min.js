window.addEventListener("DOMContentLoaded",(function(){this.window.location.pathname.match(/\/cart/i)&&(EasyPoints.Register.run(),EasyPoints.removeDiscount())}));var EasyPoints={Debug:{DEBUG:!0,print:function(t,e="info"){if(this.DEBUG)switch(t="[EasyPoints] "+t,e.toLowerCase()){case"warn":console.warn(t);break;case"error":console.error(t);break;default:console.info(t)}}},Selectors:{getElementBy$:function(t,e,n=!1){return(t=n?t.querySelectorAll(e):t.querySelector(e))||EasyPoints.Debug.print("Could not locate "+e,"warn"),t},getTotalPointsEl:function(t,e=!1){return this.getElementBy$(t,'[data-loyal-target="total-points-value"]',e)},getRedeemContainerEl:function(t,e=!1){return this.getElementBy$(t,".easy-points-form__container",e)},getRedeemPointsButtonEl:function(t,e=!1){return this.getElementBy$(t,".easy-points-button__redeem",e)},getResetPointsButtonEl:function(t,e=!1){return this.getElementBy$(t,".easy-points-button__reset",e)},getRedeemPointsInputEl:function(t,e=!1){return this.getElementBy$(t,".easy-points-form__input input",e)},getCheckoutButtonEl:function(t,e=!1){return this.getElementBy$(t,'[type="submit"][name="checkout"]',e)},getAdditionalCheckoutButtonEl:function(t,e=!1){return this.getElementBy$(t,".additional-checkout-buttons",e)}},Points:{getExcludedCost:()=>Array.from(document.querySelectorAll('[data-loyal-target="point-exclusion"]')).reduce(((t,e)=>t+parseInt(e.dataset.loyalCurrencyCost)),0),getTotalBonusPoints:(t=document)=>Array.from(t.querySelectorAll("[data-loyal-bonus-points]")).reduce(((t,e)=>{var{bonusPoints:n}=JSON.parse(e.dataset.loyalBonusPoints);return n=parseInt(n),!isNaN(n)&&n>0?t+n:t}),0),insertTotalPoints(t){EasyPoints.Selectors.getTotalPointsEl(t,!0).forEach((e=>{var n=!1,{tax:o}=JSON.parse(e.dataset.loyalOpts),s=parseInt(e.dataset.loyalCurrencyCost);o.awardable&&o.included||(n=!0,s=[...document.querySelectorAll('[data-loyal-target="point-value"]')].reduce(((t,e)=>{var{loyalCurrencyCost:n,loyalQuantity:o}=e.dataset;return n*o+t}),0));s-=EasyPoints.Points.getExcludedCost(),EasyPoints.Points.setCurrencyCost(e,{price:Math.floor(s),ignoreTax:n}),insertPointValue(e);var a=parseInt(e.innerText.replace(/\D/g,""));isNaN(a)&&(a=parseInt(e.textContent.replace(/\D/g,""))),a+=Math.round(EasyPoints.Points.getTotalBonusPoints(t)),insertPointValueIntoElement(e,a)}))},getPriceFromEl:function(t,e=null,n=/[^\d]/g){var o=e?t.querySelector(e):t;return o?100*parseInt(o.textContent.replace(n,"")):null},getTaxedCost:function({price:t,tax:e},n=null){null!==n&&n.dataset.loyalOpts&&(e=JSON.parse(n.dataset.loyalOpts).tax);return null===e?(EasyPoints.Debug.print("Tax object not defined.","error"),t):e.included||e.exempt?t:Math.floor(t*e.rate)},setCost(t,e,{price:n=null,multiplier:o=1,ignoreTax:s=!1}){if((n=(null!==n?n:parseInt(t.dataset.loyalCurrencyCost))*o)<=0)t.setAttribute(e,0);else{if(t.dataset.loyalOpts){var a=JSON.parse(t.dataset.loyalOpts);s||(n=this.getTaxedCost({price:n,tax:a.tax}))}t.setAttribute(e,n)}},setCurrencyCost(t,e){this.setCost(t,"data-loyal-currency-cost",e)},resetTargets:function(t={},e=null,n=null){var o=null!=n?n+' [data-loyal-target="point-value"]':'[data-loyal-target="point-value"]';document.querySelectorAll(o).forEach((e=>{e.classList.contains("points-after-applied-discount")||this.setCurrencyCost(e,t)})),e?e():updateLoyaltyTargets()}},Cart:{url:function(){return window.location.origin+"/cart.json"},getFromJSON:function(t){var e=new XMLHttpRequest;e.onreadystatechange=function(){if(e.readyState===XMLHttpRequest.DONE){var n=e.status;0===n||n>=200&&n<400?t(JSON.parse(e.responseText)):EasyPoints.Debug.print("Failed getting data from /cart.json","error")}},e.open("GET",this.url()),e.setRequestHeader("accept","application/json"),e.send()},setRedemptionForm:function(){this.getFromJSON((function(t){var e=document.getElementById("point-redemption-form");e&&((maxRedeemableInput=e.querySelector('input[name="coupon[max_redeemable]"]'))&&(maxRedeemableInput.value=t.total_price),t.items.forEach((function(t){var n=e.querySelectorAll('input[name="coupon[product_ids][]"]');if(!Array.prototype.find.call(n,(function(e){return e.value==t.product_id}))){var o=document.createElement("input");o.setAttribute("type","hidden"),o.setAttribute("name","coupon[product_ids][]"),o.setAttribute("value",t.product_id),e.appendChild(o),EasyPoints.Debug.print("New cart item input created for the submission form.")}})))}))}},UI:{showHidden:function(){EasyPoints.Selectors.getElementBy$(document,".hidden-unless-discount-applied",!0).forEach((t=>t.classList.remove("easy-points-hide")))},hideHidden:function(){EasyPoints.Selectors.getElementBy$(document,".hidden-unless-discount-applied",!0).forEach((t=>t.classList.add("easy-points-hide")))},cloneSubtotal:function(){EasyPoints.Selectors.getElementBy$(document,'[data-loyal-target="subtotal"]',!0).forEach((t=>{var e=t.cloneNode(!0);e.removeAttribute("data-loyal-target"),e.setAttribute("data-loyal-clone","subtotal"),t.classList.add("easy-points-hide"),t.insertAdjacentElement("beforebegin",this.modifySubtotal(e))}))},resetClonedSubtotal:function(){EasyPoints.Selectors.getElementBy$(document,"[data-loyal-clone]",!0).forEach((t=>t.remove())),EasyPoints.Selectors.getElementBy$(document,'[data-loyal-target="subtotal"]',!0).forEach((t=>t.classList.remove("easy-points-hide")))},modifySubtotal:function(t){var e=t.querySelector('[data-loyal-target="total_price"]');if(!e)return EasyPoints.Debug.print("modifySubtotal(el): missing total price target."),t;var n=EasyPoints.getDiscountSession(),o=e.dataset.loyalTotalPrice,{multiplier:s}=EasyPointsCore.Currency.getFormatOptions()||{multiplier:100},a=o-Math.round(n*EasyPointsCore.Currency.getRate()*s);if(a>=0){e.innerHTML=EasyPointsCore.Currency.format(a);var i=t.querySelector(".points-after-applied-discount");if(i){var r=parseInt(i.innerText.replace(/\D/g,"")),l=EasyPoints.Points.getTaxedCost({price:o,tax:null},i),u=EasyPoints.Points.getTaxedCost({price:a,tax:null},i);insertPointValueIntoElement(i,formatBigNumber(Math.max(0,Math.ceil(u/l*r))))}}return t},showDiscount:function(){this.showHidden(),this.buttonReset()},hideDiscount:function(){this.hideHidden(),this.buttonRedeem()},buttonRedeem:function(){EasyPoints.Selectors.getRedeemPointsInputEl(document,!0).forEach((t=>t.removeAttribute("disabled"))),EasyPoints.Selectors.getResetPointsButtonEl(document,!0).forEach((t=>t.classList.add("easy-points-hide"))),EasyPoints.Selectors.getRedeemPointsButtonEl(document,!0).forEach((t=>t.classList.remove("easy-points-hide")))},buttonReset:function(){EasyPoints.Selectors.getRedeemPointsInputEl(document,!0).forEach((t=>{t.setAttribute("disabled",!0);var e=EasyPoints.getDiscountSession();!t.classList.contains("valid")&&(""==t.value||t.value<=0)&&e>0&&(t.value=e)})),EasyPoints.Selectors.getResetPointsButtonEl(document,!0).forEach((t=>t.classList.remove("easy-points-hide"))),EasyPoints.Selectors.getRedeemPointsButtonEl(document,!0).forEach((t=>t.classList.add("easy-points-hide")))}},Tiers:{recalculate:function(t=null){var{rankAdvancementData:e}=getEasyPointsSession();if(e&&!(e.raw_amount>=0)){var n=EasyPoints.getDiscountSession(),{multiplier:o}=EasyPointsCore.Currency.getFormatOptions()||{multiplier:100},s=Math.round(n*EasyPointsCore.Currency.getRate()*o);if(null===t){var a=document.querySelector('[data-loyal-target="total_price"]');if(!a)return void EasyPoints.Debug.print("recalculate(el): missing total price target.","error");t=a.dataset.loyalTotalPrice}try{var i=EasyPointsCore.Tiers.getNextTier(t-s);i?(Array.prototype.slice.call(document.querySelectorAll('[data-loyal-target="rank-advancement-tier-name"]')).forEach((t=>{t.textContent=i.name})),Array.prototype.slice.call(document.querySelectorAll('[data-loyal-target="rank-advancement-amount"]')).forEach((t=>{t.innerHTML=EasyPointsCore.Currency.format(i.advancementAmountMultiplied)}))):Array.prototype.slice.call(document.querySelectorAll('[data-loyal-target="rank-advancement-data"] > span')).forEach((t=>{t.style.display="max-rank"==t.dataset.loyalTarget?"":"none"}))}catch{return void EasyPoints.Debug.print("EasyPoints Tiers: error getting next tier.","error")}}}},getDiscountSession:function(){var t=sessionStorage.getItem("appliedDiscount");return t?parseInt(t):0},removeDiscount:function(){if(this.getDiscountSession()>0){EasyPoints.Debug.print("Removing discount");var t=EasyPoints.Selectors.getCheckoutButtonEl(document,!0),e=EasyPoints.Selectors.getResetPointsButtonEl(document);e.setAttribute("disabled",!0),t.forEach((t=>t.setAttribute("disabled",!0))),EasyPoints.Form.setCoupon((function(){EasyPoints.reset({}),e.removeAttribute("disabled"),t.forEach((t=>t.removeAttribute("disabled")))}))}},applyDiscount:function(){var t=this.getDiscountSession();EasyPoints.Debug.print("Applying discount: "+t),t>0&&(displayDiscount(t),EasyPoints.UI.showDiscount(),EasyPoints.UI.cloneSubtotal(),EasyPoints.Selectors.getAdditionalCheckoutButtonEl(document,!0).forEach((t=>t.classList.add("easy-points-hide"))))},reset:function({event:t=null}){EasyPoints.UI.hideDiscount(),EasyPoints.UI.resetClonedSubtotal(),EasyPoints.Selectors.getAdditionalCheckoutButtonEl(document,!0).forEach((t=>t.classList.remove("easy-points-hide"))),sessionStorage.removeItem("appliedDiscount"),EasyPoints.Selectors.getRedeemPointsInputEl(document,!0).forEach((t=>t.value=""))},Form:{update({points:t}){var e=EasyPoints.Selectors.getElementBy$(document,"#redemption-point-value");return e?(e.value=t,EasyPointsCore.Validate.pointRedemption()?(sessionStorage.setItem("appliedDiscount",t),EasyPoints.Selectors.getRedeemPointsInputEl(document,!0).forEach((t=>t.classList.remove("invalid"))),!0):(sessionStorage.removeItem("appliedDiscount"),EasyPoints.Selectors.getRedeemPointsInputEl(document,!0).forEach((t=>t.classList.add("invalid"))),!1)):(sessionStorage.removeItem("appliedDiscount"),!1)},redeem({event:t=null,points:e=null}){if(null==e){if(null==t)return EasyPoints.Debug.print("redeem({event, points}): cant get the points value","error"),!1;var n=t.target.closest(".easy-points-form__container");if(!n)return EasyPoints.Debug.print("redeem({event, points}): target form is not defined"),!1;(input=EasyPoints.Selectors.getRedeemPointsInputEl(n))&&(input.value=input.value.toString().replace(/[^\d]/g,""),e=input.value)}return this.update({points:e})},setCoupon(t=null,e=null){if(null!=e&&!e||EasyPoints.getDiscountSession()>0?(EasyPoints.Debug.print("Using /redeem"),form=buildForm("/apps/loyalty/redeem")):(EasyPoints.Debug.print("Using /reset"),form=buildForm("/apps/loyalty/reset")),form){var n=new XMLHttpRequest;n.onreadystatechange=function(e){4==this.readyState&&(EasyPoints.Debug.print("Submitted"),t&&t())},n.open("POST",form.action);var o=new FormData(form);n.send(o),EasyPoints.Debug.print("Submitting form")}else t&&t()}},Register:{run:function(){updateLoyaltyTargets(),EasyPoints.Points.insertTotalPoints(document),EasyPoints.Tiers.recalculate(),this.setEventListeners(),EasyPoints.applyDiscount()},setEventListeners:function(){0!=EasyPoints.Selectors.getRedeemContainerEl(document,!0).length&&(EasyPoints.Selectors.getRedeemPointsInputEl(document,!0).forEach((t=>{t.addEventListener("focus",this.onPointsInput),t.value>0&&EasyPoints.Form.update({points:EasyPoints.getDiscountSession()})})),EasyPoints.Selectors.getRedeemPointsButtonEl(document,!0).forEach((t=>t.addEventListener("click",this.onClickRedeemBtn))),EasyPoints.Selectors.getResetPointsButtonEl(document,!0).forEach((t=>t.addEventListener("click",this.onClickResetBtn))),EasyPoints.Debug.print("Applied all required event listeners"))},onPointsInput:function(t){t.target.classList.remove("invalid")},onClickRedeemBtn:function(t){if(t.preventDefault(),EasyPoints.Debug.print("Clicked: Redeem"),EasyPoints.Form.redeem({event:t})){var e=EasyPoints.Selectors.getCheckoutButtonEl(document,!0);t.target.style.cursor="progress",t.target.setAttribute("disabled",!0),e.forEach((t=>t.setAttribute("disabled",!0))),EasyPoints.Form.setCoupon((function(){EasyPoints.applyDiscount(),t.target.style.cursor="unset",t.target.removeAttribute("disabled"),EasyPoints.Selectors.getCheckoutButtonEl(document,!0).forEach((t=>t.removeAttribute("disabled")))}))}},onClickResetBtn:function(t){t.preventDefault(),EasyPoints.Debug.print("Clicked: Reset");var e=EasyPoints.Selectors.getCheckoutButtonEl(document,!0);t.target.style.cursor="progress",t.target.setAttribute("disabled",!0),e.forEach((t=>t.setAttribute("disabled",!0))),EasyPoints.Form.setCoupon((function(){EasyPoints.reset({event:t}),t.target.style.cursor="unset",t.target.removeAttribute("disabled"),e.forEach((t=>t.removeAttribute("disabled")))}))}}};
